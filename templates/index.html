<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Data with Graphs</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <!-- Add Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCZdPNeOyjsW9qjKrDLabWSCwFBg-b5NxA",
            authDomain: "predictive-maintenance-ee697.firebaseapp.com",
            databaseURL: "https://predictive-maintenance-ee697-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "predictive-maintenance-ee697",
            storageBucket: "predictive-maintenance-ee697.firebasestorage.app",
            messagingSenderId: "905376142266",
            appId: "1:905376142266:web:dc081d8bb7d6bab62e4383",
            measurementId: "G-B57LTZHVZ4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Arrays to store time-series data
        let timeData = []; // Timestamps
        let currentData = []; // Current values
        let vibrationData = []; // Vibration values
        let temperatureData = []; // Temperature values

        // Function to update graphs
        function updateGraphs() {
            // Update Current vs Time graph
            const currentGraph = {
                x: timeData,
                y: currentData,
                type: 'scatter',
                name: 'Current'
            };
            Plotly.newPlot('graph1', [currentGraph], { title: 'Current vs Time' });

            // Update Vibration vs Time graph
            const vibrationGraph = {
                x: timeData,
                y: vibrationData,
                type: 'scatter',
                name: 'Vibration'
            };
            Plotly.newPlot('graph2', [vibrationGraph], { title: 'Vibration vs Time' });

            // Update Temperature vs Time graph
            const temperatureGraph = {
                x: timeData,
                y: temperatureData,
                type: 'scatter',
                name: 'Temperature'
            };
            Plotly.newPlot('graph3', [temperatureGraph], { title: 'Temperature vs Time' });
        }

        // Function to update prediction status
        function updatePredictionStatus(faultValue) {
            const predictionBox = document.getElementById('prediction-box');
            if (faultValue === 1) {
                predictionBox.textContent = "Fault Detected!";
                predictionBox.style.backgroundColor = "red";
            } else {
                predictionBox.textContent = "No Fault";
                predictionBox.style.backgroundColor = "green";
            }
        }

        // Fetch data from Realtime Database
        const dbRef = ref(database, '/'); // Fetch data from the root of the database
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            console.log("Fetched data:", data); // Check the console to see the fetched data

            if (data && data.Sensor && data.Prediction) {
                // Get current timestamp
                const timestamp = new Date().toLocaleTimeString();

                // Add new data to the arrays
                timeData.push(timestamp);
                currentData.push(data.Sensor.Current || 0); // Default to 0 if undefined
                vibrationData.push(data.Sensor.Vibration || 0); // Default to 0 if undefined
                temperatureData.push(data.Sensor.Temperature || 0); // Default to 0 if undefined

                // Keep only the last 10 data points (for better visualization)
                if (timeData.length > 10) {
                    timeData.shift();
                    currentData.shift();
                    vibrationData.shift();
                    temperatureData.shift();
                }

                // Update the graphs
                updateGraphs();

                // Update the prediction status
                updatePredictionStatus(data.Prediction.Fault);
            } else {
                console.error("Sensor or Prediction data is missing in Firebase!");
            }
        });

        // Handle the toggle switch
        const toggleSwitch = document.getElementById('toggle-switch');
        toggleSwitch.addEventListener('change', function() {
            const switchState = this.checked ? 'ON' : 'OFF';
            alert(`Switch is ${switchState}`);
            // You can add logic here to send the switch state to Firebase or perform other actions
        });
    </script>
    <style>
        .graph-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        .graph {
            width: 100%;
            height: 300px;
            margin: 10px;
        }
        .prediction-box {
            text-align: center;
            margin: 20px;
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            color: white;
            border-radius: 10px;
        }
        .switch {
            text-align: center;
            margin: 20px;
        }
    </style>
</head>
<body>
    <h1>Firebase Data with Graphs</h1>
    <div class="graph-container">
        <div id="graph1" class="graph"></div>
        <div id="graph2" class="graph"></div>
        <div id="graph3" class="graph"></div>
    </div>
    <div id="prediction-box" class="prediction-box">No Fault</div>
    <div class="switch">
        <label for="toggle-switch">Toggle Switch:</label>
        <input type="checkbox" id="toggle-switch">
    </div>
</body>
</html>